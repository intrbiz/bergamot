<!DOCTYPE balsa SYSTEM "http://balsa.intrbiz.net/balsa.dtd">
<?RenderLibrary com.intrbiz.balsa?>
<!-- The index view -->
<fragment xmlns="com.intrbiz.balsa" title="Hello #{Balsa().currentPrincipal().summary}">

    <script src="#{public('/js/' + bergamot_js_version() + '/u2f-api.js')}"></script>

	<div class="row submenu pull-right">
		<a href="/change-password?redirect=#{path('/profile/')}">Change password</a>
	</div>

	<div class="row">
		<div class="col4 dash_icon">
			<h3>Your details</h3>
		    <p>
			    <span class="label">Username: </span>
			    <span class="value">#{contact.name}</span>
		    </p>
		    <p>
			    <span class="label">Email: </span>
			    <span class="value">#{coalesce(contact.email, '')}</span>
		    </p>
		    <p>
			    <span class="label">Pager: </span>
			    <span class="value">#{coalesce(contact.pager, '')}</span>
		    </p>
		    <p>
			    <span class="label">Mobile: </span>
			    <span class="value">#{coalesce(contact.mobile, '')}</span>
		    </p>
		    <p>
			    <span class="label">Phone: </span>
			    <span class="value">#{coalesce(contact.phone, '')}</span>
		    </p>
		    <p class="description">
			    #{coalesce(contact.description, '')}
		    </p>
		</div>
		<div class="col4">
			<h3>Member of</h3>
			<data-set var="team" value="#{contact.teams}">
				<p>
					<span>#{team.summary}</span>
				</p>
			</data-set>
		</div>
	</div>
    
    <div class="row">
    	<h3>Your Authentication Tokens</h3>
    	<p class="text-body">
    		Authentication tokens are used to login to Bergamot without requiring a username and password, 
    		these tokens can be used to authenticate with the Bergamot API, with the CLI and to login automatically. 
    	</p>
    	<div class="col12">
	    	<table>
	    		<tr>
	    			<th>Token</th>
	    			<th>Purpose</th>
	    			<th>Created</th>
	    			<th>Revoked</th>
	    			<th></th>
	    			<th></th>
	    		</tr>
				<data-set var="token" value="#{contact.getAPITokens()}">
					<tr>
						<td>#{token.token}</td>
						<td>#{token.summary}</td>
						<td>#{dateformat('yyyy-MM-dd', token.created)} at #{dateformat('hh:mm:ss', token.created)}</td>
						<td>#{if(token.revoked, 'On ' + dateformat('yyyy-MM-dd', token.revokedAt) + ' at ' + dateformat('hh:mm:ss', token.revokedAt), 'No')}</td>
						<td>
							<form action="#{path('/profile/revoke-api-token')}" method="post">
								<input type="hidden" name="token" value="#{token.token}"/>
								<input type="submit" name="revoke" value="Revoke" class="danger"/>
							</form>
						</td>
						<td>
							<form action="#{path('/profile/remove-api-token')}" method="post">
								<input type="hidden" name="token" value="#{token.token}"/>
								<input type="submit" name="remove" value="Remove" class="danger"/>
							</form>
						</td>
					</tr>
				</data-set>
			</table>
		</div>
		<p class="text-body">
    		<h4>Generate authentication token</h4>
    		<form action="#{path('/profile/generate-api-token')}" method="post">
    			<label for="summary">Purpose: </label>
    			<input type="text" name="summary" placeholder="API Access"/>
    			<input type="submit" name="generate" value="Generate"/>
    		</form>
    	</p>
	</div>
	
	<div class="row">
    	<h3>Your Securit Keys</h3>
    	<p class="text-body">
    		Security Keys help prevent unauthorised access to your account. 
        </p>
        <p class="text-body">
            Once a Security Key is registered to your account 
            you will have to use it as well as your password to login.
    	</p>
        <p class="text-body">
            Your Security Key will need to be compatible with the U2F protocol 
            and you will need to use a supported browser.
        </p>
    	<div class="col12">
	    	<table>
	    		<tr>
	    		    <th>Device</th>
	    			<th>Registered</th>
	    			<th>Revoked</th>
	    			<th></th>
	    			<th></th>
	    		</tr>
				<data-set var="device" value="#{contact.getU2FDeviceRegistrations()}">
					<tr>
						<td>
							<img rendered="#{device.deviceImage != null}" src="#{device.deviceImage}"/>
							<span>Your #{coalesce(device.device, 'U2F Device')} by #{coalesce(device.vendor, 'Unknown')}</span>
						</td>
						<td>#{dateformat('yyyy-MM-dd', device.created)} at #{dateformat('hh:mm:ss', device.created)}</td>
						<td>#{if(device.revoked, 'On ' + dateformat('yyyy-MM-dd', device.revokedAt) + ' at ' + dateformat('hh:mm:ss', device.revokedAt), 'No')}</td>
						<td>
							<form action="#{path('/profile/revoke-u2f-device')}" method="post">
								<input type="hidden" name="id" value="#{device.id}"/>
								<input type="submit" name="revoke" value="Revoke" class="danger"/>
							</form>
						</td>
						<td>
							<form action="#{path('/profile/remove-u2f-device')}" method="post">
								<input type="hidden" name="id" value="#{device.id}"/>
								<input type="submit" name="remove" value="Remove" class="danger"/>
							</form>
						</td>
					</tr>
				</data-set>
			</table>
		</div>
		<p class="text-body">
    		<h4>Register your Security Key</h4>
    		<span>Please insert your Security Key to register it.</span>
    		<form id="u2f-register" action="#{path('/profile/register-u2f-device')}" method="post">
    			<input id="u2f-register-request" name="u2f-register-request" type="hidden" value="#{u2fregister.toJson()}" />
    			<input id="u2f-register-response" name="u2f-register-response" type="hidden" value="" />
    			<input type="submit" name="u2f-register-go" value="Register My Device"/>
    		</form>
    		<script>
    			$(document).ready(function() {
    				$('#u2f-register').submit(function(ev) {
    				    if ($('#u2f-register').attr('data-state') != 'go')
    				    {
	    				    ev.preventDefault();
	    				    var req = JSON.parse($('#u2f-register-request').val());
	    				    /*alert('Please insert your U2F device');*/
	    				    u2f.register(req.registerRequests, req.authenticateRequests,
						    function(data) {
						        if(data.errorCode)
						        {
						            alert("U2F failed with error: " + data.errorCode);
						            return;
						        }
						        $('#u2f-register-response').val(JSON.stringify(data));
						        $('#u2f-register').attr('data-state', 'go');
						        $('#u2f-register').submit();
						    });
					    }
    				});
    			});
    		</script>
    	</p>
	</div>
    
</fragment>
