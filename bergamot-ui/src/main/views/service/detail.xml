<!DOCTYPE balsa SYSTEM "http://balsa.intrbiz.net/balsa.dtd">
<?RenderLibrary com.intrbiz.balsa?>
<!-- The index view -->
<fragment xmlns="com.intrbiz.balsa" title="Service #{service.summary} on Host #{service.host.summary}">

	<div class="row submenu pull-right">
		<a rendered="#{service.suppressed}"  href="/service/unsuppress/#{service.id}">Unsupress</a>
		<a rendered="#{!service.suppressed}" href="/service/suppress/#{service.id}">Supress</a>
		<a rendered="#{service.enabled}"     href="/service/disable/#{service.id}">Disable</a>
		<a rendered="#{!service.enabled}"    href="/service/enable/#{service.id}">Enable</a>
		<a href="/service/execute/#{service.id}" id="check-now" data-check-id="#{service.id}">Check now</a>
	</div>

	<div class="row">
		<div class="col4 dash_icon check" data-check-id="#{service.id}">
			<h3>
				<span class="dash_img #{service.state.status.toString().toLowerCase()}" title="The service is #{service.state.status.toString().toLowerCase()}">
					<img src="/service-icon.png" />
				</span>
				<span class="name">#{service.summary}</span>
		    </h3>
		    <p>
			    <span class="label wide">Status: </span>
			    <span class="value">#{service.state.status.toString().substring(0,1) + service.state.status.toString().substring(1).toLowerCase()}</span>
		    </p>
		    <p>
			    <span class="label wide">Host: </span>
			    <a href="/host/name/#{service.host.name}">
				    <span class="value">#{service.host.summary}</span>
				</a>
		    </p>
		    <p>
			    <span class="label wide">Attempt: </span>
			    <span class="value">
			    	<span>#{service.state.attempt} of #{service.currentAttemptThreshold}</span>
			    	<span class="info" rendered="#{service.state.transitioning}" title="The service is changing state">Changing</span>
			    	<span class="info" rendered="#{service.state.hard}" title="The service is in a steady state">Steady</span>
			    </span>
		    </p>
		    <p>
			    <span class="label wide">Suppressed: </span>
			    <span class="value">#{if(service.suppressed, 'yes', 'no')}</span>
		    </p>
		    <p>
			    <span class="label wide">Enabled: </span>
			    <span class="value">#{if(service.enabled, 'yes', 'no')}</span>
		    </p>
		    <p>
			    <span class="label wide">Last checked: </span>
			    <span class="value">#{dateformat('HH:mm:ss', service.state.lastCheckTime)} on #{dateformat('EEEE dd/MM/yyyy', service.state.lastCheckTime)}</span>
		    </p>
		    <p>
			    <span class="label wide">Last state change: </span>
			    <span class="value">#{dateformat('HH:mm:ss', service.state.lastStateChange)} on #{dateformat('EEEE dd/MM/yyyy', service.state.lastStateChange)}</span>
		    </p>
		    <p>
			    <span class="label wide">Last status: </span>
			    <span class="value">#{service.state.lastHardStatus.toString().substring(0,1) + service.state.lastHardStatus.toString().substring(1).toLowerCase()}</span>
		    </p>
		    <p class="output">
			    <span class="label wide">Output: </span>
			    <span class="value">#{coalesce(service.state.output, '')}</span>
		    </p>
		</div>
	</div>
	
	<!-- History -->
	
	<container rendered="#{! alerts.isEmpty()}">
	
		<h2>Alert History</h2>
				
		<data-set var="alert" value="#{alerts}">
			<div class="row">
			    <div class="col4 dash_icon alert">
					<h3>
						<span class="dash_img #{alert.status.toString().toLowerCase()}" title="The service is #{alert.status.toString().toLowerCase()}">
							<img src="/service-icon.png" />
						</span>
						<span class="name">#{service.summary}</span>
				    </h3>
				    <p>
					    <span class="label">Status: </span>
					    <span class="value">#{alert.status.toString().substring(0,1) + alert.status.toString().substring(1).toLowerCase()}</span>
				    </p>
				    <p class="output">
					    <span class="label">Output: </span>
					    <span class="value">#{coalesce(alert.output, '')}</span>
				    </p>
			    </div>
			    <div class="col4 dash_icon alert">
				    <p>
					    <span class="label">Raised: </span>
					    <span class="value">#{dateformat('HH:mm:ss', alert.raised)} on #{dateformat('EEEE dd/MM/yyyy', alert.raised)}</span>
				    </p>
				    <p>
					    <span class="label">Recovered: </span>
					    <span class="value">#{if(alert.recovered, 'Yes', 'No')}</span>
				    </p>
				    <p rendered="#{alert.recovered}">
				    	<span class="label">Recovered At: </span>
					    <span class="value">#{dateformat('HH:mm:ss', alert.recoveredAt)} on #{dateformat('EEEE dd/MM/yyyy', alert.recoveredAt)}</span>
				    </p>
			    </div>
			    <div class="col4 dash_icon alert">
				    <p>
					    <span class="label">Acknowledged: </span>
					    <span class="value">#{if(alert.acknowledged, 'Yes', 'No')}</span>
				    </p>
				    <p rendered="#{alert.acknowledged}">
				    	<span class="label">Recovered At: </span>
					    <span class="value">#{dateformat('HH:mm:ss', alert.acknowledgedAt)} on #{dateformat('EEEE dd/MM/yyyy', acknowledgedAt)}</span>
				    </p>
			    </div>
			</div>
		</data-set>
	
	</container>
	
	<container rendered="#{Balsa().permission('ui.config.view')}">
	
		<h2>Configuration</h2>
		
		<div class="row">
			<div class="col4 dash_icon">
				<h3>Notify</h3>
				<data-set var="contact" value="#{service.contacts}">
					<p>
						<span class="label wide">Contact</span>
						<span class="value"><a href="/contact/id/#{contact.id}">#{contact.summary}</a></span>
					</p>
				</data-set>
				<data-set var="team" value="#{service.teams}">
					<p>
						<span class="label wide">Team</span>
						<span class="value"><a href="/team/id/#{team.id}">#{team.summary}</a></span>
					</p>
				</data-set>
			</div>
			<div class="col4 dash_icon">
				<h3>Scheduling</h3>
				<p>
					<span class="label wide">Check period</span>
					<span class="value"><a href="/timeperiod/id/#{service.timePeriod.id}">#{service.timePeriod.summary}</a></span>
				</p>
				<p>
					<span class="label wide">Check interval</span>
					<span class="value">#{service.checkInterval / 1000}s</span>
				</p>
				<p>
					<span class="label wide">Retry interval</span>
					<span class="value">#{service.retryInterval / 1000}s</span>
				</p>
			</div>
			<div class="col4 dash_icon">
				<h3>Notifications</h3>
				<p>
					<span class="label wide">Notifications enabled</span>
					<span class="value">#{if(service.notifications.enabled, 'yes', 'no')}</span>
				</p>
				<p>
					<span class="label wide">Notification period</span>
					<span class="value"><a href="/timeperiod/id/#{service.notifications.timePeriod.id}">#{service.notifications.timePeriod.summary}</a></span>
				</p>
			</div>
		</div>
		
		<div class="row">
			<div class="col4 dash_icon">
				<h3>Statistics</h3>
				<p>
					<span class="label wide">Last runtime: </span>
					<span class="value">#{service.state.lastRuntime} ms</span>
				</p>
				<p>
					<span class="label wide">Average runtime: </span>
					<span class="value">#{service.state.averageRuntime} ms</span>
				</p>
				<p>
					<span class="label wide">Last processing latency: </span>
					<span class="value">#{service.state.lastCheckProcessingLatency} ms</span>
				</p>
				<p>
					<span class="label wide">Average processing latency: </span>
					<span class="value">#{service.state.averageCheckProcessingLatency} ms</span>
				</p>
				<p>
					<span class="label wide">Last execution latency: </span>
					<span class="value">#{service.state.lastCheckExecutionLatency} ms</span>
				</p>
				<p>
					<span class="label wide">Average execution latency: </span>
					<span class="value">#{service.state.averageCheckExecutionLatency} ms</span>
				</p>
			</div>
			<div class="col4 dash_icon">
				<h3>Command</h3>
				<p>
					<span class="label wide">Command Engine: </span>
					<span class="value">#{service.checkCommand.command.engine}</span>
				</p>
				<p>
					<span class="label wide">Command Name: </span>
					<span class="value">#{service.checkCommand.command.name}</span>
				</p>
				<p>
					<span class="label wide">Parameters:</span>
					<span class="value">&nbsp;</span>
				</p>
				<data-set var="parameter" value="#{service.checkCommand.resolveCheckParameters()}">
					<p>
						<span class="label wide indent">#{parameter.name}: </span>
						<span class="value">#{parameter.value}</span>
					</p>
				</data-set>
			</div>
		</div>
		
		<div class="row">
			<div class="col12">
				<h3>XML</h3>
				<pre>#{service.configuration.toString()}</pre>
			</div>
		</div>
	
	</container>
	
	<script type="text/javascript">
		require(["bergamot/lib/util/console-log", "bergamot/lib/ui/check-state", "bergamot/lib/data/api-driver"], function(bergamot_console_log, bergamot_ui_server_state, bergamot_api_driver)
		{
		    bergamot_console_log.attachTo(document);

		    bergamot_ui_server_state.attachTo("div.check");

		    bergamot_api_driver.attachTo(document, {
				url: "ws://" + #{'"' + Balsa().request.serverName + '"'} + "/websocket",
		    });
		});
		// execute check
		$(document).ready(function() {
			$('#check-now').click(function(ev) {
				ev.preventDefault();
				var id = $(this).attr("data-check-id");
				$.getJSON('/api/service/id/' + id + '/execute', function(data) { /* all ok */ });
			});
		});
	</script>
	
</fragment>